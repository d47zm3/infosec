#!/bin/bash

# install exploit development tools

function decho
{
        string=$1
        echo "[$( date +'%H:%M:%S' )] ${string}"
}

os_version=""

decho "creating exploit dev environment..."
function setup
{
  decho "detecting os..."
  which apt 1>/dev/null
  if [[ ${?} -eq 0 ]]
  then
    decho "debian/kali detected..."
    os_version="debian"
  fi

  if [[ -z "${os_version}" ]]
  then
    decho "[error] no supported os was detected, exit..."
    exit 1
  fi

  decho "update system..."
  if [[ "${os}" -eq "debian" ]]
  then
    apt -y update && apt -y upgrade
  fi
  decho "installing basic development libraries..."
  if [[ "${os}" -eq "debian" ]]
  then
    apt -y install build-essential
  fi
  
  decho "looking for python..."

  which python 1>/dev/null
  if [[ ${?} -eq 1 ]]
  then
    decho "python not found, installing..."
    # python has to exist on centos, only debian can need it
    apt -y install python
  fi

  decho "looking for git..."
  which git 1>/dev/null
  if [[ ${?} -eq 1 ]]
  then
    decho "git not found, installing..."
    if [[ "${os}" -eq "debian" ]]
    then
      apt -y install git
    fi
  fi
}

function install_pwntools
{
  decho "installing pwntools..."
  if [[ "${os}" -eq "debian" ]]
  then
    apt install python2.7 python-pip python-dev git libssl-dev libffi-dev build-essential
    pip install --upgrade pip
    pip install --upgrade pwntools
  fi
}

function install_peda
{

  decho "installing peda..."
  git clone https://github.com/longld/peda.git ~/peda
  echo "source ~/peda/peda.py" >> ~/.gdbinit
  echo "DONE! debug your program with gdb and enjoy"
}

function install_radare2
{

  decho "installing radare2..."
  cd /opt
  git clone https://github.com/radare/radare2.git
  cd radare2
  sys/install.sh
}

function install_utils
{
  decho "installing common utils..."
  decho "installing vim..."
  apt install vim-nox
  decho "installing tmux..."
  apt install tmux
  decho "installing tmux-plugin-manager..."
  git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
  decho "installing zsh..."
  apt install zsh
  decho "installing prezto - zsh framework..."
  git clone --recursive https://github.com/sorin-ionescu/prezto.git "${ZDOTDIR:-$HOME}/.zprezto"

cat > /tmp/prezto.sh <<\EOF
#/bin/zsh
setopt EXTENDED_GLOB
for rcfile in "${ZDOTDIR:-$HOME}"/.zprezto/runcoms/^README.md(.N); do
  ln -s "$rcfile" "${ZDOTDIR:-$HOME}/.${rcfile:t}"
done
echo "update your default shell to zsh..."
chsh -s /bin/zsh
EOF
  chmod +x /tmp/prezto.sh
  /bin/zsh /tmp/prezto.sh
  decho "change default template to minimal..." 
  sed -i "s/theme 'sorin'/theme 'minimal'/g" ~/.zpreztorc
}

install_configs
{
  wget -O ~/.tmux.conf
  wget -O ~/.vimrc
}

check_versions
{

  decho "checking radare2 version..."
  /opt/radare2/binr/radare2/radare2 -v
  decho "checking pwntools version..."
  python -c 'from pwn import *'
}

### main
setup
install_peda
install_pwntools
install_radare2
install_utils
